<div id="wrapper">
    <div id="page" class="home-1">
        <header id="header_main" class="header_1 header-fixed">
            <div class="themesflat-container">
                <div class="row">
                    <div class="col-md-12">                              
                        <div id="site-header-inner"> 
                            <div class="wrap-box flex">
                               <div id="site-logo">
                                  <div *ngIf="isUserLoggedIn">
                                    <a [routerLink]="['/tabs/home']" (click)="closeMobileNav()" rel="home" class="main-logo">
                                      <img [src]="profile.avatar" alt="avatar" style="height: 40px;border-radius: 10px;" />
                                    </a>
                                    <span class="wallet-address">
                                      {{ activeWallet ? shorten(activeWallet) : profile!.email }}
                                    </span>
                                  </div>

                                  <div *ngIf="!isUserLoggedIn">
                                    <a [routerLink]="['/login']" class="tf-button style-1">
                                      <span>Login / Signup</span>
                                    </a>
                                  </div>
                                </div>

                                <div class="mobile-button" *ngIf="isUserLoggedIn" (click)="toggleMobileNav()">
                                  <span></span>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>
            <div class="mobile-nav-wrap" [class.active]="mobileNavActive" *ngIf="isUserLoggedIn">
              <div class="overlay-mobile-nav" (click)="closeMobileNav()"></div>
              <div class="inner-mobile-nav">
                <a [routerLink]="['/tabs/home']" (click)="closeMobileNav()" rel="home" class="main-logo">
                  <img [src]="profile.avatar" alt="avatar" style="width: 30%;border-radius: 10px;" />
                </a>

                <!-- tombol close -->
                <div class="mobile-nav-close" (click)="closeMobileNav()">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="20px" height="20px" viewBox="0 0 122.878 122.88">
                    <path d="M1.426,8.313c-1.901-1.901-1.901-4.984,0-6.886c1.901-1.902,4.984-1.902,6.886,0l53.127,53.127l53.127-53.127
                      c1.901-1.902,4.984-1.902,6.887,0c1.901,1.901,1.901,4.985,0,6.886L68.324,61.439l53.128,53.128c1.901,1.901,1.901,4.984,0,6.886
                      c-1.902,1.902-4.985,1.902-6.887,0L61.438,68.326L8.312,121.453c-1.901,1.902-4.984,1.902-6.886,0
                      c-1.901-1.901-1.901-4.984,0-6.886l53.127-53.128L1.426,8.313L1.426,8.313z"/>
                  </svg>
                </div>

                <!-- menu -->
                <nav id="mobile-main-nav" class="mobile-main-nav">
                  <ul id="menu-mobile-menu" class="menu">

                    <!-- Wallet aktif -->
                    <li class="menu-item current-item" *ngIf="activeWalletData">
                      <a class="item-menu-mobile flex-between">
                        <span (click)="closeMobileNav()">
                          {{ shorten(activeWalletData.address) }}
                        </span>
                        <ion-icon
                          name="copy-outline"
                          (click)="onCopyIconClick($event, activeWalletData.address)">
                        </ion-icon>
                      </a>
                    </li>

                    <!-- Player -->
                    <li class="menu-item" *ngIf="profile?.player">
                      <a class="item-menu-mobile flex-between" (click)="closeMobileNav()">
                        <span>Rank: <strong>{{ profile!.player?.rank | titlecase }}</strong></span>
                        <span class="wallet-balance">
                          Earning Point {{ profile!.player?.totalEarning | number:'1.2-2' }}
                        </span>
                      </a>
                    </li>

                    <!-- Referral Code -->
                    <li class="menu-item" *ngIf="profile?.referral">
                      <a class="item-menu-mobile flex-between"
                         (click)="onCopyIconClick($event, profile!.referral?.code || '')">
                        <span>Referral Code: <strong>{{ profile!.referral?.code }}</strong></span>
                        <ion-icon name="copy-outline"></ion-icon>
                      </a>
                    </li>

                    <!-- Referral Summary -->
                    <li class="menu-item" *ngIf="profile?.referral">
                      <a class="item-menu-mobile flex-between" (click)="closeMobileNav()">
                        <span>Claimable:</span>
                        <span class="wallet-balance">{{ profile!.referral?.totalClaimable | number:'1.4-4' }}</span>
                      </a>
                      <a class="item-menu-mobile flex-between" (click)="closeMobileNav()">
                        <span>Claimed:</span>
                        <span class="wallet-balance">{{ profile!.referral?.totalClaimed | number:'1.4-4' }}</span>
                      </a>

                      <div class="flex-between mt-2">
                        <button
                          class="btn-claim"
                          [disabled]="isClaiming || (profile!.referral?.totalClaimable ?? 0) < 0.06"
                          (click)="claimReferral()">
                          {{ isClaiming ? 'Processing...' : 'Claim Reward' }}
                        </button>
                      </div>
                    </li>

                    <!-- Settings -->
                    <li class="menu-item" *ngIf="isUserLoggedIn">
                      <a class="item-menu-mobile" [routerLink]="['/market-layout/setting']" (click)="closeMobileNav()">
                        Settings
                      </a>
                    </li>

                    <!-- Withdraw -->
                    <li class="menu-item" *ngIf="profile.role == 'admin' || profile.role == 'signer1' || profile.role == 'signer2'">
                      <a class="item-menu-mobile" (click)="closeMobileNav(); openWithdrawModal()">
                        Withdraw
                      </a>
                    </li>

                    <li class="menu-item" *ngIf="profile.role == 'admin' || profile.role == 'signer1' || profile.role == 'signer2'">
                      <a class="item-menu-mobile" (click)="closeMobileNav(); openPrizepoolModal()">
                        Share Prizepool
                      </a>
                    </li>

                    <!-- Logout -->
                    <li class="menu-item" *ngIf="isUserLoggedIn">
                      <a class="item-menu-mobile" (click)="logout()">
                        Logout
                      </a>
                    </li>

                  </ul>
                </nav>
              </div>
            </div>

        </header>

        <!-- Modal Withdraw -->
        <div class="custom-modal" *ngIf="showWithdrawModal">
          <div class="modal-backdrop" (click)="resetWithdrawModal()"></div>
          <div
            class="modal-sheet"
            [ngClass]="{ 'slide-up': !isClosingWithdraw, 'slide-down': isClosingWithdraw }"
          >
            <h2 class="modal-title">Withdraw Treasury</h2>

            <!-- Treasury fee info -->
            <div class="widget-table-ranking pb-20">
              <div class="table-ranking-content">
                <div class="fl-row-ranking">
                  <div class="td1">
                    <div class="item-name">
                      <!-- üîπ Nama token -->
                      Treasury Balance

                      <!-- üí∞ Harga NFT (harga listing dalam token ini) -->
                      <h6 class="price gem">
                        {{ treasuryBalance!.sol | number:'1.4-4' }} SOL
                      </h6>

                      <!-- üëõ Tambahan: saldo pengguna -->
                      <span class="warning pt-1">
                        ${{ treasuryBalance!.usdValue | number:'1.2-2' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <form (submit)="submitWithdraw()">
              <!-- =========================================
                   üëë ADMIN ONLY ‚Äî tampilkan input nominal
              ==========================================-->
              <ng-container *ngIf="withdrawStage === 'admin'; else signerStage">
                <input
                  type="number"
                  [(ngModel)]="withdrawAmount"
                  name="withdrawAmount"
                  placeholder="Enter amount (SOL)"
                  class="search-field style-1"
                  min="0"
                  step="0.0001"
                  required
                />
              </ng-container>

              <!-- =========================================
                   ‚úçÔ∏è SIGNER1 & SIGNER2 ‚Äî hanya tampil tombol
              ==========================================-->
              <ng-template #signerStage>
                <div class="text-center pt-10 pb-20">
                  <h5 *ngIf="withdrawStage === 'signer1'">
                    ‚úçÔ∏è Please sign the transaction 
                    <span class="warning">
                      {{ amountWithdraw }} SOL 
                    </span> as <b>Signer 1</b>.
                  </h5>
                  <h5 *ngIf="withdrawStage === 'signer2'">
                    ‚úÖ Sign and broadcast 
                    <span class="warning">
                      {{ amountWithdraw }} SOL 
                    </span> as <b>Signer 2</b>.
                  </h5>
                  <p class="text-sm gray pt-5">
                    You don‚Äôt need to input any amount ‚Äî just sign the pending transaction.
                  </p>
                </div>
              </ng-template>

              <!-- =========================================
                   üîò Tombol Aksi
              ==========================================-->
              <div class="modal-actions pt-20">
                <button type="button" class="btn-cancel" (click)="resetWithdrawModal()">Cancel</button>

                <button type="submit" class="btn-send">
                  {{
                    withdrawStage === 'admin'
                      ? 'Withdraw'
                      : withdrawStage === 'signer1'
                      ? 'Sign Transaction'
                      : withdrawStage === 'signer2'
                      ? 'Confirm & Broadcast'
                      : 'Processing...'
                  }}
                </button>
              </div>
            </form>

          </div>
        </div>

        <div class="custom-modal" *ngIf="showPrizepoolModal">
          <div class="modal-backdrop" (click)="closePrizepoolModal()"></div>

          <div class="modal-sheet" [ngClass]="{ 'slide-up': !isClosingPrizepool, 'slide-down': isClosingPrizepool }">

            <!-- ===========================================================
                STEP 1 ‚Äî LIST ALL ELIGIBLE PLAYERS + PRIZEPOOL SUMMARY
            ============================================================ -->
            <div *ngIf="!isDistributing && !distributionSuccess">

              <h2 class="modal-title">Prizepool Distribution</h2>

              <!-- TREASURY / PRIZEPOOL SUMMARY -->
              <div class="widget-table-ranking pb-20">
                <div class="table-ranking-content">
                  <div class="fl-row-ranking">
                    <div class="td1">
                      <div class="item-name">
                        <div class="pt-10">
                          <label>Prizepool</label>
                          <h4 class="success">{{ prizepoolFinal | number:'1.6-6' }} SOL</h4>
                          <span class="warning">${{ treasuryBalance.usdValue | number:'1.2-2' }}</span>
                        </div>

                        <div class="pt-10">
                          <label>Eligible Players:</label>
                          <h5>{{ eligiblePlayers }}</h5>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ===========================================================
                  PLAYER DISTRIBUTION LIST
              ============================================================ -->
              <form action="#" method="get" role="search" class="search-form relative" (submit)="$event.preventDefault()">
                <input
                  type="search"
                  id="search"
                  class="search-field style-1"
                  placeholder="Search player..."
                  [(ngModel)]="playerSearch"
                  name="playerSearch"
                />
                <button class="search search-submit" type="submit"><i class="icon-search"></i></button>
              </form>

              <div class="widget-table-ranking pb-20" *ngIf="filteredPlayers.length > 0">
                <div
                  class="table-ranking-content"
                  *ngFor="let p of filteredPlayers"
                >
                  <div class="fl-row-ranking">
                    <div class="td1">
                      <div class="item-name">
                        <h6>{{ p.username }}</h6>

                        <span class="balance-info text-sm warning pt-1">
                          {{ p.wallet | slice:0:6 }}...{{ p.wallet | slice:-4 }}
                        </span>
                      </div>
                    </div>

                    <div class="td5">
                      <h6 class="price gem">
                        {{ p.shareSol | number:'1.6-6' }} SOL
                      </h6>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ACTIONS -->
              <div class="modal-actions pt-20">
                <button class="btn-cancel" (click)="closePrizepoolModal()">Cancel</button>
                <button class="btn-send" (click)="submitPrizepool()">Distribute Now</button>
              </div>

            </div>

            <!-- ===========================================================
                STEP 2 ‚Äî PROCESSING / SUCCESS
            ============================================================ -->
            <div *ngIf="isDistributing || distributionSuccess" @fadeSlide>

              <!-- PROCESSING -->
              <div *ngIf="isDistributing">
                <h2 class="modal-title">Processing Distribution...</h2>
                <div class="loading-spinner">
                  <ion-spinner name="crescent"></ion-spinner>
                </div>
              </div>

              <!-- SUCCESS -->
              <div *ngIf="distributionSuccess" class="success-tx" @fadeSlide>
                <h2 class="modal-title">Distribution Simulated</h2>
                <ion-icon name="checkmark-circle-outline"></ion-icon>

                <p>Prizepool has been successfully simulated.</p>

                <div class="modal-actions">
                  <button class="btn-cancel" (click)="closePrizepoolModal()">Close</button>
                </div>
              </div>

            </div>

          </div>
        </div>

    </div>
</div>

<ion-tabs>
    <ion-tab-bar slot="bottom" class="bottom-tab-bar">
        <ion-tab-button tab="all-collection" [routerLink]="['/market-layout/all-collection']" routerLinkActive="active">
            <ion-icon name="storefront-outline"></ion-icon>
            <!-- <ion-label>All</ion-label> -->
        </ion-tab-button>

        <ion-tab-button tab="my-nfts" [routerLink]="['/market-layout/my-nfts']" routerLinkActive="active">
            <ion-icon name="grid-outline"></ion-icon>
            <!-- <ion-label>My NFT</ion-label> -->
        </ion-tab-button>

        <ion-tab-button *ngIf="profile.role == 'admin' || profile.role == 'signer1' || profile.role == 'signer2'" tab="creates" [routerLink]="['/market-layout/creates']" routerLinkActive="active">
            <ion-icon name="duplicate-outline"></ion-icon>
            <!-- <ion-label>Creates</ion-label> -->
        </ion-tab-button>

        <ion-tab-button *ngIf="profile.role == null" tab="gatcha" [routerLink]="['/market-layout/gatcha']" routerLinkActive="active">
            <ion-icon name="dice-outline"></ion-icon>
            <!-- <ion-label>Creates</ion-label> -->
        </ion-tab-button>

        <ion-tab-button *ngIf="profile.role == 'user'" tab="gatcha" [routerLink]="['/market-layout/gatcha']" routerLinkActive="active">
            <ion-icon name="dice-outline"></ion-icon>
            <!-- <ion-label>Creates</ion-label> -->
        </ion-tab-button>

        <ion-tab-button tab="my-favorite" [routerLink]="['/market-layout/my-favorite']" routerLinkActive="active">
            <ion-icon name="heart-outline"></ion-icon>
            <!-- <ion-label>Favorite</ion-label> -->
        </ion-tab-button>

        <ion-tab-button tab="transactions" [routerLink]="['/market-layout/transactions']" routerLinkActive="active">
            <ion-icon name="time-outline"></ion-icon>
            <!-- <ion-label>History</ion-label> -->
        </ion-tab-button>
    </ion-tab-bar>

</ion-tabs>